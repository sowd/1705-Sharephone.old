<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8">
</head>
<body style="overflow:auto;height:100%;">
<font style='color:#ccc'>Phone UI (Enterで送信):</font>
<input type='text' id='myname' size='7' placeholder="自分の名前"></input>
<input type='text' id='sendtext' size='40' placeholder='送りたい言葉'></input>
<span id='msgarea'></span>
<hr />
<div id="left" style="float:left;width:30%;overflow-y:scroll;height:100%;">
<font size='+2' style='color:#ccc'>Suggestions</font>
<span id='qresult'></span>
</div>
<div id="center" style="float:left;width:40%;overflow-y:scroll;background-color:#eef;height:100%;">
	<font size='+2' style='color:#ccc'>Dialog</font>
	<div id='chattxt' style=""></div>
</div>
<div id="right" style="float:right;width:30%;overflow-y:scroll;height:100%;">
<font size='+2' style='color:#ccc'>Diary</font>
</div>
</body>
<script src='jquery.min.js'></script>
<script src='bot.js'></script>
<script>

const IMAGES_PATH = '/images/' ;
//const WORD_FREQ_THRESHOLD = 1 ;
//const WORD_FREQ_THRESHOLD = 0.0011 ;


var log = console.log ;

////////////////////////////////
// Utilities
function msg(msg){
	$('#msgarea').text( msg ) ;
	log(msg) ;
}

function addutt(bMy , txt){
	var ht ;
	if(bot==undefined) ht = 'Not connected.' ;
	else {
		var name = (bMy?bot.name:bot.tgtname) ;
		ht = `${name} : ${txt}` ;

		$.getJSON( '/mecab/' ,{ q:txt } , m_re=>{
			var urls = {} ;
			m_re.forEach(w=>{
				//if( w[1]=='名詞' /*w[2]=='固有名詞'*/ ) words += ','+w[0] ;
				if( tagged_images[w[0]] == undefined ) return ;
				tagged_images[w[0]].forEach(url=>{
					urls[url]=null;
				}) ;
			})

			var q_ht = '' ;
			for( var iurl in urls )
				q_ht += `<img src="${IMAGES_PATH}${iurl}" width="100%"></img>` ;
			$('#qresult').html(q_ht) ;
		} ) ;
	}
	$('#chattxt').append(ht+'<br />') ;
}

// Word2vec
/*$.ajax({
	//type: オプションは$.ajaxの初期値で"GET"です。
	url: '/w2v/'
	, dataType: 'json'
	, data: { q:tgt_word }
	, success: w_re=>{
		if( w_re.error != undefined || w_re.freq>WORD_FREQ_THRESHOLD){
			word_analylsis_completed() ;
			return ;
		}
		$(tgt_id).css('color','#f00') ;

		if( lines[lid].analysis == undefined ){
			lines[lid].analysis = {w2v:w_re.w2v , w2vnum:1} ;
		} else {
			var an = lines[lid].analysis ;
			if( w_re.w2v == undefined ){
				console.log('Why?') ;
			}
			for( var vi=0;vi<w_re.w2v.length;++vi )
				an.w2v[vi] += w_re.w2v[vi] ;
			++ an.w2vnum ;
		}

		//sel_words[tgt_word] = w_re.w2v ;
		corpus_words[tgt_word].w2v = w_re.w2v ;
		corpus_words[tgt_word].freq = w_re.freq ;
		corpus_words[tgt_word].tf = w_re.tf ;

		word_analylsis_completed() ;
	}
	, error: word_analylsis_completed
});*/


var bot ;
var tagged_images = {} ;
onload = function(){


	$.getJSON( IMAGES_PATH+'index.json' , m_re=>{
		tagged_images = m_re ;
	} ) ;


	$( '#myname' ).keypress( function ( e ) {if ( e.which == 13 ) {
		var myname = $('#myname').val() ;
		bot = new Bot(myname,'ドモ子');
		bot.talk().then(utt=>{
			addutt(false,utt) ;
		}) ;
		return false;
	} } );

	$( '#sendtext' ).keypress( function ( e ) {if ( e.which == 13 ) {
		if( bot == undefined ){
			alert('Please call to bot first.') ;
			return ;
		}

	    var sendtxt = $('#sendtext').val() ;
	    addutt(true,sendtxt) ;
		$('#sendtext').val('') ;
		bot.talk(sendtxt).then(utt=>{
			addutt(false,utt) ;
		}) ;
	} } );
} ;
</script>
</html>