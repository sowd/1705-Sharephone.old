<!DOCTYPE HTML>
<html>
<head>
</head>
<body>
<select id='corpusselect'><option value="null">Select corpus</select><br />
<div id='srctxt'></div>
</body>
<script src='jquery.min.js'></script>
<script>

const WORD_FREQ_THRESHOLD = 0.0011 ;

var log = console.log ;

var raw_lines = [] , lines = [] ;

function genhtline(li){
	var l = lines[li] ;
	return `${l.lineid}:${l.speaker}:<span id="line_${li}" style="color:#aaa;">${l.content}</span><br />` ;
}

function oncorpusloaded(){
	if( raw_lines.length==0 ){
		alert('No corpus selected.') ;
		return ;
	}

	var ht = '' ;
	var speaker = '' ;
	lines = [] ;
	
	raw_lines.forEach( line => {
		var match_result = line.match( /(^[MF]...)：/ ) ;
			if( match_result == null ) return ;
		var speaker = match_result[1] ;
		var body = line.slice(5) ;

		var lineid = lines.length ;

		lines.push( {lineid:lineid , speaker:speaker , content: body } )
		ht += genhtline(lineid) ;
		analyze(lineid) ;
	}) ;

	$('#srctxt').html(ht) ;
}

function analyze(lineid){
	$.getJSON(
		'/mecab/'
		,{ q:lines[lineid].content }
		,m_re=>{
			// Mecab completed
			//log('形態素解析結果：'+JSON.stringify(m_re)) ;

			// highlight 名詞
			var ht = '' ;
			for( var wi=0;wi<m_re.length;++wi){
				var w = m_re[wi] ;
				if( w[0] == 'F' || w[1] != '名詞' || (w[2] != '固有名詞' && w[2] != '一般') ){
				//if( w[2] != '固有名詞' ){
					ht += w[0] ;
					continue ;
				}
				ht += `<span id="word_${lineid}_${wi}" style="color:#000;">[${w[0]}]</span>` ;

				(()=>{
					var tgt_id = `#word_${lineid}_${wi}` ;
					// analyze by word2vec
					$.getJSON(
						'/w2v/'
						,{ q:w[0] }
						,w_re=>{
							if(w_re.freq>WORD_FREQ_THRESHOLD) return ;
							$(tgt_id).css('color','#f00') ;
						}
					) ;
				})() ;
			}

			$('#line_'+lineid).html(ht) ;

		}
	);
}

onload = function(){
	$.getJSON('/corpus/',re=>{
		var selector = $('#corpusselect') ;
		re.corpus.forEach(corpusname=>{
			var option = $('<option>')
				.val(corpusname)
				.text(corpusname)
				//.prop('selected', isSelected)
				;
			selector.append(option) ;
		}) ;
		selector.change(()=>{
			//log( selector.val() );
			$.getJSON('/corpus/'+selector.val(),
				_lines=>{raw_lines=_lines;oncorpusloaded();}
			) ;
		}) ;
	}) ;
} ;
</script>
</html>